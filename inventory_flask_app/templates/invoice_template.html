<style>
@media print {
    .no-print {
        display: none;
    }
}
</style>
<style>
.invoice-table th.serial-col, .invoice-table td.serial-col { width: 12%; }
.invoice-table th.model-col, .invoice-table td.model-col { width: 40%; }
.invoice-table th.currency-col, .invoice-table td.currency-col { width: 9%; text-align: right; }
</style>

<div class="container">
    <h2>ðŸ§¾ Invoice #{{ invoice.id if invoice else invoice_number }}</h2>

    <p><strong>Customer:</strong> {{ customer.name }}</p>
    <p><strong>Invoice Date:</strong>
      {% if invoice %}
        {{ invoice.created_at.strftime('%Y-%m-%d') if invoice.created_at else "" }}
      {% else %}
        {{ sale_date }}
      {% endif %}
    </p>

    <div style="overflow-x:auto;">
        <table class="table table-bordered mt-4 invoice-table">
            <thead>
                <tr>
                    <th class="serial-col">Serial Number</th>
                    <th class="model-col">Model & Specs</th>
                    <th class="currency-col">Unit Price (AED)</th>
                    <th class="currency-col">VAT %</th>
                    <th class="currency-col">VAT Amount (AED)</th>
                    <th class="currency-col">Total With VAT (AED)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    {% set unit_price = item.unit_price if item.unit_price is defined else (item.price_at_sale if item.price_at_sale is defined else item.price) %}
                    {% set vat_rate = item.vat_rate if item.vat_rate is defined else 5 %}
                    {% set vat_amount = unit_price * (vat_rate / 100) %}
                    {% set total_with_vat = unit_price + vat_amount %}
                    <tr>
                        <td class="serial-col">{{ item.serial_number }}</td>
                        <td class="model-col">{{ item.specs }}</td>
                        <td class="currency-col">{{ "%.2f"|format(unit_price) }}</td>
                        <td class="currency-col">{{ vat_rate }}</td>
                        <td class="currency-col">{{ "%.2f"|format(vat_amount) }}</td>
                        <td class="currency-col">{{ "%.2f"|format(total_with_vat) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h4 class="mt-4">Summary:</h4>
    <ul>
        <li><strong>Subtotal (AED):</strong> {{ "%.2f"|format(subtotal) }}</li>
        <li><strong>Total VAT (AED):</strong> {{ "%.2f"|format(total_vat) }}</li>
        <li><strong>Grand Total (AED, incl. VAT):</strong> {{ "%.2f"|format(grand_total) }}</li>
    </ul>

    {% if is_preview %}
      <div class="mt-4">
        <div class="alert alert-info">This is a preview only. To complete the sale, return to the previous tab and click "Create Invoice".</div>
        <button onclick="window.close()" class="btn btn-secondary btn-lg w-100 mt-2">Close Preview</button>
      </div>
    {% endif %}

    <div class="mt-4 no-print">
        <a href="/main_dashboard" class="btn btn-primary btn-lg w-100 mt-2">Back to Dashboard</a>
    </div>
</div>