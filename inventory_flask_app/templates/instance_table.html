{% extends "base.html" %}
{% block content %}
<style>
.fixed-inventory-header {
  position: fixed;
  top: 0;
  left: 240px;
  right: 0;
  background: #fff;
  z-index: 1051;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  border-bottom: 1px solid #eee;
  padding: 24px 0 12px 0;
}
@media (max-width: 991px) {
  .fixed-inventory-header { left: 0; }
}
.fixed-inventory-header .row {
  width: 100%;
}
.inventory-actions {
  display: flex;
  gap: 12px;
  flex-shrink: 0;
}
.inventory-actions .btn {
  min-width: 200px;
  width: 100%;
  font-size: 0.95rem;
  font-weight: 500;
  padding: 0.55rem 1.25rem;
  border-radius: 2rem;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}
@media (max-width: 767px) {
  .inventory-actions {
    flex-direction: column;
    width: 100%;
  }
  .inventory-actions .btn {
    min-width: 100% !important;
    margin-bottom: 8px;
  }
}
.inventory-main-content {
  margin-top: 120px;
  padding: 0 16px;
  width: 100%;
}
.comfortable-table {
  border-collapse: separate;
  border-spacing: 0 6px;
}

.comfortable-table th {
  padding: 10px 12px;
  font-size: 13px;
  font-weight: 600;
  background: #f0f2f5;
  border: none;
  color: #333;
}

.comfortable-table td {
  padding: 8px 12px;
  font-size: 13px;
  background: #fff;
  vertical-align: middle;
  border: none;
  border-top: 1px solid #eee;
  border-bottom: 1px solid #eee;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}

.comfortable-table tbody tr:hover td {
  background-color: #f1f2f5;
}

.comfortable-table .btn {
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 0.5rem;
}
.comfortable-table thead th {
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 2;
  box-shadow: 0 2px 2px -1px rgba(0,0,0,0.06);
}
.instances-card {
  background: #f6f7fa;
  border-radius: 1.1rem;
  box-shadow: 0 2px 12px #0057b710;
  border: none;
  padding: 2.3rem 1.2rem 1.4rem 1.2rem;
}
.batch-action-bar .btn {
  border-radius: 2rem !important;
  font-weight: 500;
  font-size: 0.97rem;
}
.btn {
  color: #222 !important;
}
.btn:hover {
  color: #000 !important;
}
.btn-outline-dark:hover {
  background-color: #e4e6e9;
  color: #111;
  border-color: #bbb;
}
</style>
<style>
.comfortable-table td,
.comfortable-table th {
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
  max-width: 180px;
}

.comfortable-table th:nth-child(1),
.comfortable-table td:nth-child(1) {
  width: 40px;
}

.comfortable-table th:nth-child(2),
.comfortable-table td:nth-child(2) {
  min-width: 100px;
}

.comfortable-table td a.btn {
  white-space: nowrap;
}
</style>
<div class="fixed-inventory-header">
  <div class="container-fluid">
    <div class="row w-100">
      <div class="col d-flex flex-column justify-content-start">
        <h2 class="mb-2">
          <i class="bi bi-list-ul me-2"></i>{{ title }}
        </h2>
      </div>
      <div class="col-auto inventory-actions align-items-center">
        <a href="{{ url_for('stock_bp.export_instances', **request.args) }}" class="btn btn-outline-dark btn-lg rounded-pill">Export to Excel</a>
        <a href="{{ url_for('stock_bp.scan_move') }}" class="btn btn-outline-primary btn-lg rounded-pill">
          Move Units
        </a>
        <a href="{{ url_for('stock_bp.bin_lookup') }}" class="btn btn-outline-secondary btn-lg rounded-pill">
          <i class="bi bi-upc-scan me-1"></i>Scan/Lookup Bin
        </a>
      </div>
    </div>
  </div>
</div>
<div class="inventory-main-content">
  <div class="instances-card mt-4">
    <p class="text-muted small mb-3">    
  <form method="get" class="row g-2 mb-4">
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="status" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="all" {% if request.args.get('status', 'all') == 'all' %}selected{% endif %}>All Statuses</option>
          <option value="unprocessed" {% if request.args.get('status') == 'unprocessed' %}selected{% endif %}>Unprocessed</option>
          <option value="under_process" {% if request.args.get('status') == 'under_process' %}selected{% endif %}>Under Process</option>
          <option value="processed" {% if request.args.get('status') == 'processed' %}selected{% endif %}>Processed</option>
          <option value="disputed" {% if request.args.get('status') == 'disputed' %}selected{% endif %}>Disputed</option>
        </select>
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <input type="text" name="model" id="model-search" value="{{ request.args.get('model', '') }}" class="form-control rounded-pill" placeholder="Search Model..." autocomplete="off" list="model-suggestions" />
        <datalist id="model-suggestions"></datalist>
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="processor" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="">Filter by Processor</option>
          {% for p in processors %}
            <option value="{{ p }}" {% if request.args.get('processor') == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      {% if rams %}
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="ram" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="">Filter by RAM</option>
          {% for r in rams %}
            <option value="{{ r }}" {% if request.args.get('ram') == r %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="location_id" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="">All Locations</option>
          {% for loc in locations %}
            <option value="{{ loc.id }}" {% if request.args.get('location_id') == loc.id|string %}selected{% endif %}>
              {{ loc.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      {% if disk1sizes %}
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="disk1size" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="">Filter by Disk Size</option>
          {% for d in disk1sizes %}
            <option value="{{ d }}" {% if request.args.get('disk1size') == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <input type="text" name="serial_search" value="{{ request.args.get('serial_search', '') }}" class="form-control rounded-pill" placeholder="Search Serial...">
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <input type="text" name="bin_search" value="{{ request.args.get('bin_search', '') }}" class="form-control rounded-pill" placeholder="Search Bin #...">
      </div>
      <div class="col-12 col-md-auto d-flex gap-2 align-items-end">
        <button class="btn btn-outline-primary rounded-pill shadow-sm" type="submit" style="min-height: 42px;">Apply Filters</button>
        <a href="{{ url_for('stock_bp.under_process') }}" class="btn btn-outline-secondary rounded-pill shadow-sm" style="min-height: 42px;">Clear Filters</a>
      </div>
    </form>
    <div class="mb-2 text-start">
      <strong>{{ instances|length }} item{{ 's' if instances|length != 1 else '' }} found</strong>
    </div>
    <form method="post" action="{{ url_for('stock_bp.print_labels_batch') }}" target="_blank" id="batch-print-form">
      <div class="mb-2 w-100">
        <button type="submit" class="btn btn-outline-dark rounded-pill batch-action-bar">üñ®Ô∏è Print Selected Labels</button>
      </div>
      <div style="overflow-x:auto;">
        {% set column_order = (settings.column_order_instance_table or '').split(',') %}
        <table class="table table-striped comfortable-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all-labels" onclick="for(let cb of document.querySelectorAll('.batch-label-checkbox')) cb.checked=this.checked;"></th>
              {% set key_map = {
                'model_number': 'model',
                'product': 'item_name',
                'processor': 'cpu',
                'video_card': 'gpu1',
                'resolution': 'display'
              } %}
              {% for key in column_order %}
                {% set normalized_key = key_map.get(key, key) %}
                {% if settings['show_column_' ~ key] == 'true' %}
                  <th>{{ settings['label_' ~ key]|default(normalized_key|replace('_', ' ')|title) }}</th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for i in instances %}
              <tr>
                <td><input type="checkbox" class="batch-label-checkbox" name="instance_ids" value="{{ i.id }}"></td>
                {% set key_map = {
                  'model_number': 'model',
                  'product': 'item_name',
                  'processor': 'cpu',
                  'video_card': 'gpu1',
                  'resolution': 'display'
                } %}
                {% for key in column_order %}
                  {% set normalized_key = key_map.get(key, key) %}
                  {% if settings['show_column_' ~ key] == 'true' %}
                    {% if normalized_key == 'asset' %}
                      <td>{{ i.asset }}</td>
                    {% elif normalized_key == 'serial' %}
                      <td>{{ i.serial }}</td>
                    {% elif normalized_key == 'item_name' %}
                      <td>{{ i.product.item_name if i.product else '' }}</td>
                    {% elif normalized_key == 'make' %}
                      <td>{{ i.product.make if i.product else '' }}</td>
                    {% elif normalized_key == 'model' %}
                      <td>{{ i.product.model if i.product else '' }}</td>
                    {% elif normalized_key == 'cpu' %}
                      <td>{{ i.product.cpu if i.product else '' }}</td>
                    {% elif normalized_key == 'ram' %}
                      <td>{{ i.product.ram if i.product else '' }}</td>
                    {% elif normalized_key == 'gpu1' %}
                      <td>{{ i.product.gpu1 if i.product else '' }}</td>
                    {% elif normalized_key == 'gpu2' %}
                      <td>{{ i.product.gpu2 if i.product else '' }}</td>
                    {% elif normalized_key == 'display' %}
                      <td>{{ i.product.display if i.product else '' }}</td>
                    {% elif normalized_key == 'disk1size' %}
                      <td>{{ i.product.disk1size if i.product else '' }}</td>
                    {% elif normalized_key == 'grade' %}
                      <td>{{ i.product.grade if i.product else '' }}</td>
                    {% elif normalized_key == 'location' %}
                      <td>{{ i.location.name if i.location else '' }}</td>
                    {% elif normalized_key == 'status' %}
                      <td>{{ i.status }}</td>
                    {% elif normalized_key == 'process_stage' %}
                      <td>{{ i.process_stage or '' }}</td>
                    {% elif normalized_key == 'team_assigned' %}
                      <td>{{ i.team_assigned or '' }}</td>
                    {% elif normalized_key == 'shelf_bin' %}
                      <td>{{ i.shelf_bin or '' }}</td>
                    {% elif normalized_key == 'is_sold' %}
                      <td>{{ 'Yes' if i.is_sold else 'No' }}</td>
                    {% elif normalized_key == 'label' %}
                      <td>
                        <a href="{{ url_for('stock_bp.print_label', instance_id=i.id) }}" class="btn btn-outline-dark rounded-pill px-4 text-nowrap" style="min-width: 140px;" target="_blank">üñ®Ô∏è Print Label</a>
                      </td>
                    {% elif normalized_key == 'action' %}
                      <td>
                        <a href="{{ url_for('stock_bp.view_edit_instance', instance_id=i.id) }}" class="btn btn-sm btn-outline-info rounded-pill">View/Edit</a>
                      </td>
                    {% else %}
                      <td>-</td>
                    {% endif %}
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>
<script>
  const modelInput = document.getElementById('model-search');
  const modelDatalist = document.getElementById('model-suggestions');
  let lastFetch = '';
  let fetchTimeout = null;

  modelInput.addEventListener('input', function(e) {
    const query = this.value;
    if (query.length < 2) {
      modelDatalist.innerHTML = '';
      return;
    }
    if (query === lastFetch) return;
    lastFetch = query;

    clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(() => {
      fetch(`/stock/api/model_suggestions?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(models => {
          modelDatalist.innerHTML = '';
          for (const m of models) {
            const opt = document.createElement('option');
            opt.value = m;
            modelDatalist.appendChild(opt);
          }
        });
    }, 180);
  });

  document.addEventListener("DOMContentLoaded", function () {
    const table = $('.comfortable-table').DataTable({ pageLength: 50 });

    document.getElementById("select-all-labels").addEventListener("change", function () {
      const checked = this.checked;
      table.rows().every(function () {
        const row = this.node();
        const checkbox = row.querySelector('.batch-label-checkbox');
        if (checkbox) checkbox.checked = checked;
      });
    });

    const form = document.getElementById("batch-print-form");
    form.addEventListener("submit", function () {
      // remove any previously added hidden inputs
      document.querySelectorAll('input[name="instance_ids"][type="hidden"]').forEach(el => el.remove());

      table.rows().every(function () {
        const row = this.node();
        const checkbox = row.querySelector('.batch-label-checkbox');
        if (checkbox && checkbox.checked) {
          const hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.name = "instance_ids";
          hiddenInput.value = checkbox.value;
          form.appendChild(hiddenInput);
        }
      });
    });
  });
</script>
{% endblock %}
.sidebar .nav-link:hover {
  background-color: #f1f2f5;
  color: #000;
}