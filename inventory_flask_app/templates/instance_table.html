{% extends "base.html" %}
{% block content %}
<style>
.fixed-inventory-header {
  position: fixed;
  top: 0;
  left: 240px;
  right: 0;
  background: #fff;
  z-index: 1051;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  border-bottom: 1px solid #eee;
  padding: 24px 0 12px 0;
}
@media (max-width: 991px) {
  .fixed-inventory-header { left: 0; }
}
.fixed-inventory-header .row {
  width: 100%;
}
.inventory-actions {
  display: flex;
  gap: 12px;
  flex-shrink: 0;
}
.inventory-actions .btn {
  min-width: 200px;
}
.inventory-main-content {
  margin-top: 165px;
  padding: 0 16px;
  width: 100%;
}
.comfortable-table th, .comfortable-table td {
  font-size: 13px;
  padding: 6px 12px;
}
.comfortable-table .btn {
  font-size: 12px;
  padding: 4px 10px;
}
.comfortable-table thead th {
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 2;
  box-shadow: 0 2px 2px -1px rgba(0,0,0,0.06);
}
.instances-card {
  background: #f6f7fa;
  border-radius: 1.1rem;
  box-shadow: 0 2px 12px #0057b710;
  border: none;
  padding: 2.3rem 1.2rem 1.4rem 1.2rem;
}
.batch-action-bar .btn {
  border-radius: 2rem !important;
  font-weight: 500;
  font-size: 0.97rem;
}
</style>
<div class="fixed-inventory-header">
  <div class="container-fluid">
    <div class="row w-100">
      <div class="col d-flex flex-column justify-content-start">
        <h2 class="mb-2">
          <i class="bi bi-list-ul me-2"></i>{{ title }}
        </h2>
      </div>
      <div class="col-auto inventory-actions align-items-center">
        <a href="{{ url_for('stock_bp.export_instances', **request.args) }}" class="btn btn-success btn-lg rounded-pill">Export to Excel</a>
        <a href="{{ url_for('stock_bp.scan_move') }}" class="btn btn-warning btn-lg rounded-pill">
          <i class="bi bi-upc-scan me-1"></i>Scan & Assign/Move
        </a>
        <a href="{{ url_for('stock_bp.bin_lookup') }}" class="btn btn-info btn-lg rounded-pill">
          <i class="bi bi-upc-scan me-1"></i>Scan/Lookup Bin
        </a>
      </div>
    </div>
  </div>
</div>
<div class="inventory-main-content">
  <div class="instances-card">
    <form method="get" class="row g-2 mb-4">
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="status" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="all" {% if request.args.get('status', 'all') == 'all' %}selected{% endif %}>All Statuses</option>
          <option value="unprocessed" {% if request.args.get('status') == 'unprocessed' %}selected{% endif %}>Unprocessed</option>
          <option value="under_process" {% if request.args.get('status') == 'under_process' %}selected{% endif %}>Under Process</option>
          <option value="processed" {% if request.args.get('status') == 'processed' %}selected{% endif %}>Processed</option>
          <option value="disputed" {% if request.args.get('status') == 'disputed' %}selected{% endif %}>Disputed</option>
        </select>
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <input type="text" name="model" id="model-search" value="{{ request.args.get('model', '') }}" class="form-control rounded-pill" placeholder="Search Model..." autocomplete="off" list="model-suggestions" />
        <datalist id="model-suggestions"></datalist>
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="processor" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="">Filter by Processor</option>
          {% for p in processors %}
            <option value="{{ p }}" {% if request.args.get('processor') == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <select name="location_id" class="form-select rounded-pill" onchange="this.form.submit()">
          <option value="">All Locations</option>
          {% for loc in locations %}
            <option value="{{ loc.id }}" {% if request.args.get('location_id') == loc.id|string %}selected{% endif %}>
              {{ loc.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <input type="text" name="serial_search" value="{{ request.args.get('serial_search', '') }}" class="form-control rounded-pill" placeholder="Search Serial...">
      </div>
      <div class="col-12 col-md-3 mb-2 mb-md-0">
        <input type="text" name="bin_search" value="{{ request.args.get('bin_search', '') }}" class="form-control rounded-pill" placeholder="Search Bin #...">
      </div>
      <div class="col-12 col-md-auto d-flex gap-2 align-items-end">
        <button class="btn btn-outline-primary rounded-pill btn-lg" type="submit">Apply Filters</button>
        <a href="{{ url_for('stock_bp.under_process') }}" class="btn btn-outline-secondary rounded-pill btn-lg">Clear Filters</a>
      </div>
    </form>
    <div class="mb-3 text-end">
      <strong>{{ instances|length }} item{{ 's' if instances|length != 1 else '' }} found</strong>
    </div>
    <form method="post" action="{{ url_for('stock_bp.print_labels_batch') }}" target="_blank" id="batch-print-form">
      <div class="mb-2">
        <button type="submit" class="btn btn-dark rounded-pill batch-action-bar">üñ®Ô∏è Print Selected Labels</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="table table-striped comfortable-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all-labels" onclick="for(let cb of document.querySelectorAll('.batch-label-checkbox')) cb.checked=this.checked;">
              </th>
              <th>Serial</th>
              <th>Product</th>
              <th>Model</th>
              <th class="d-none d-md-table-cell">Vendor</th>
              <th>Status</th>
              <th>Process Stage</th>
              <th>Team</th>
              <th>Location</th>
              <th>Shelf/Bin</th>
              <th class="d-none d-md-table-cell">RAM</th>
              <th class="d-none d-md-table-cell">Processor</th>
              <th class="d-none d-md-table-cell">Storage</th>
              <th class="d-none d-md-table-cell">Screen Size</th>
              <th class="d-none d-md-table-cell">Resolution</th>
              <th class="d-none d-md-table-cell">Grade</th>
              <th class="d-none d-md-table-cell">Video Card</th>
              <th class="d-none d-md-table-cell">Is Sold</th>
              <th class="d-none d-md-table-cell" style="width:100px;">Label</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for i in instances %}
              <tr>
                <td>
                  <input type="checkbox" class="batch-label-checkbox" name="instance_ids" value="{{ i.id }}">
                </td>
                <td>{{ i.serial_number }}</td>
                <td>{{ i.product.name if i.product else '' }}</td>
                <td>{{ i.product.model_number if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.vendor.name if i.product and i.product.vendor else '' }}</td>
                <td>{{ i.status }}</td>
                <td>{{ i.process_stage or '' }}</td>
                <td>{{ i.team_assigned or '' }}</td>
                <td>{{ i.location.name if i.location else '' }}</td>
                <td>{{ i.shelf_bin or '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.ram if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.processor if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.storage if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.screen_size if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.resolution if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.grade if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ i.product.video_card if i.product else '' }}</td>
                <td class="d-none d-md-table-cell">{{ 'Yes' if i.is_sold else 'No' }}</td>
                <td class="d-none d-md-table-cell">
                  <a href="{{ url_for('stock_bp.print_label', instance_id=i.id) }}"
                    class="btn btn-sm btn-outline-dark rounded-pill" target="_blank">
                    üñ®Ô∏è Print Label
                  </a>
                </td>
                <td>
                  <a href="{{ url_for('stock_bp.view_edit_instance', instance_id=i.id) }}" class="btn btn-sm btn-outline-info rounded-pill">View/Edit</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>
<script>
  const modelInput = document.getElementById('model-search');
  const modelDatalist = document.getElementById('model-suggestions');
  let lastFetch = '';
  let fetchTimeout = null;

  modelInput.addEventListener('input', function(e) {
    const query = this.value;
    if (query.length < 2) {
      modelDatalist.innerHTML = '';
      return;
    }
    if (query === lastFetch) return;
    lastFetch = query;

    clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(() => {
      fetch(`/stock/api/model_suggestions?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(models => {
          modelDatalist.innerHTML = '';
          for (const m of models) {
            const opt = document.createElement('option');
            opt.value = m;
            modelDatalist.appendChild(opt);
          }
        });
    }, 180);
  });
</script>
{% endblock %}