{% extends "base.html" %}
            
{% block content %}

<style>
.create-sale-card {
  background: #f3f4f8;
  border-radius: 1.2rem;
  box-shadow: 0 2px 16px #0057b710;
  border: none;
  padding: 2rem 1.4rem 1.4rem 1.4rem;
  max-width: 850px;
  margin: 0 auto;
}
.create-sale-heading {
  font-size: 1.62rem;
  font-weight: 700;
  letter-spacing: 0.01em;
}
@media (max-width: 600px) {
  .create-sale-card { padding: 1.2rem 0.3rem; }
  .create-sale-heading { font-size: 1.15rem; }
}
</style>

{% if selected_instances %}
<script>
var products = [
  {% for item in selected_instances %}
  {
    product_instance_id: {{ item.id }},
    serial_number: "{{ item.serial_number }}",
    name: "{{ item.product.name|e }}",
    model_number: "{{ item.product.model_number|e }}",
    cpu: "{{ item.product.processor|e }}",
    ram: "{{ item.product.ram|e }}",
    storage: "{{ item.product.storage|e }}",
    gpu: "{{ item.product.video_card|e }}",
    grade: "{{ item.product.grade|e }}",
    screen_size: "{{ item.product.screen_size|e }}",
    price_at_sale: 0
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];
</script>
{% else %}
<script>
var products = [];
</script>
{% endif %}

<div class="create-sale-card mt-5">
  <div class="mb-4 text-center">
    <h2 class="create-sale-heading mb-1">
      <i class="bi bi-receipt text-primary me-2"></i>Create Sale Invoice
    </h2>
    <div class="text-muted" style="font-size:1.07rem;">Complete the fields below to generate an invoice</div>
  </div>
  <form id="saleForm">
      <div class="mb-3">
          <label for="customerSelect" class="form-label">Select Customer:</label>
          <div class="d-flex flex-column flex-md-row">
              <select id="customerSelect" class="form-select form-control-lg me-md-2 rounded-pill px-3" name="customer_id" required>
                  <option value="">-- Select Customer --</option>
                  {% for customer in customers %}
                      <option value="{{ customer.id }}"
                          {% if selected_customer_id and customer.id|string == selected_customer_id|string %}selected{% endif %}
                      >{{ customer.name }}</option>
                  {% endfor %}
              </select>
              <a href="{{ url_for('customers_bp.add_customer') }}" class="btn btn-primary rounded-pill fw-semibold btn-lg w-100 mt-2 mt-md-0">‚ûï Add New Customer</a>
          </div>
      </div>
      
      <div id="scan-add-row" class="mb-3">
          <div class="mb-3">
              <label for="scanSerial" class="form-label">Scan or Type Serial Number:</label>
              <input type="text" id="scanSerial" class="form-control form-control-lg rounded-pill px-3" placeholder="Enter or scan serial number">
          </div>
          <button type="button" class="btn btn-primary btn-lg w-100 mt-2 rounded-pill fw-semibold" onclick="addProduct()">Add Product</button>
      </div>
              
      <div style="overflow-x:auto;">
        <table class="table table-hover table-sm align-middle" id="productTable" style="display: none;">
            <thead>
                <tr>
                    <th>Serial Number</th>
                    <th>Product Name</th>
                    <th>Model Number</th>
                    <th class="d-none d-md-table-cell">CPU</th>
                    <th class="d-none d-md-table-cell">RAM</th>
                    <th class="d-none d-md-table-cell">Storage</th>
                    <th class="d-none d-md-table-cell">GPU</th>
                    <th class="d-none d-md-table-cell">Grade</th>
                    <th class="d-none d-md-table-cell">Screen</th>
                    <th class="d-none d-md-table-cell">Price (USD)</th>
                    <th>Remove</th>
                </tr>
            </thead>
            <tbody id="productList"></tbody>
        </table>
      </div>
          
      <button type="submit" id="submitInvoiceBtn" class="btn btn-success btn-lg w-100 mt-2 rounded-pill fw-semibold" style="display: none;">Confirm Sale & Create Invoice</button>
      <button type="button" id="previewInvoiceBtn" class="btn btn-info btn-lg w-100 mt-2 rounded-pill fw-semibold" style="display: none;">Preview Invoice</button>
  </form>
</div>

<!-- Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header align-items-center">
        <h5 class="modal-title me-3" id="invoicePreviewModalLabel">Invoice Preview</h5>
        <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="printPreviewInvoice()">üñ®Ô∏è Print</button>
        <button type="button" class="btn btn-outline-success btn-sm me-2" id="downloadPdfBtn" style="display:none;">‚¨áÔ∏è Download PDF</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="preview-container">
        <!-- Invoice HTML will be inserted here -->
      </div>
    </div>
  </div>
</div>
            
<script>
function addProduct() {
    const serial = document.getElementById('scanSerial').value.trim();
    if (!serial) {
        alert('Please scan or enter a serial number.');
        return;
    }

    // Check for duplicate serial number in products
    if (products.some(p => p.serial_number === serial)) {
        alert('This product is already added to the sale.');
        return;
    }

    fetch(`/get_product_by_serial/${serial}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Prevent adding already sold products
            if (data.is_sold) {
                alert('This product has already been sold.');
                return;
            }

            const product = {
                product_instance_id: data.product_instance_id,
                serial_number: data.serial_number,
                name: data.name,
                model_number: data.model_number,
                cpu: data.processor,         // map backend 'processor' to JS 'cpu'
                ram: data.ram,
                storage: data.storage,
                gpu: data.video_card,        // map backend 'video_card' to JS 'gpu'
                grade: data.grade,
                screen_size: data.screen_size,
                price_at_sale: 0
            };

            products.push(product);
            updateProductTable();
            document.getElementById('scanSerial').value = '';
        })
        .catch(err => {
            console.error('Fetch error:', err);
            alert('Product not found or server error.');
        });
}

// Listen for Enter key on the serial input to trigger addProduct
document.getElementById('scanSerial').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addProduct();
    }
});

function updateProductTable() {
    const table = document.getElementById('productTable');
    const tbody = document.getElementById('productList');
    tbody.innerHTML = '';

    let total = 0;
    products.forEach((product, index) => {
        total += parseFloat(product.price_at_sale) || 0;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.serial_number}</td>
            <td>${product.name}</td>
            <td>${product.model_number}</td>
            <td class="d-none d-md-table-cell">${product.cpu || ''}</td>
            <td class="d-none d-md-table-cell">${product.ram || ''}</td>
            <td class="d-none d-md-table-cell">${product.storage || ''}</td>
            <td class="d-none d-md-table-cell">${product.gpu || ''}</td>
            <td class="d-none d-md-table-cell">${product.grade || ''}</td>
            <td class="d-none d-md-table-cell">${product.screen_size || ''}</td>
            <td class="d-none d-md-table-cell"><input type="number" value="${product.price_at_sale}" min="0" onchange="updatePrice(${index}, this.value)" class="form-control"></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(${index})">Remove</button></td>
        `;
        tbody.appendChild(row);
    });

    // Add total row if products exist
    if (products.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `
            <td colspan="9" style="text-align:right;"><strong>Total:</strong></td>
            <td colspan="2"><strong>$${total.toFixed(2)}</strong></td>
        `;
        tbody.appendChild(totalRow);
        table.style.display = '';
        document.getElementById('submitInvoiceBtn').style.display = '';
        document.getElementById('previewInvoiceBtn').style.display = '';
    } else {
        table.style.display = 'none';
        document.getElementById('submitInvoiceBtn').style.display = 'none';
        document.getElementById('previewInvoiceBtn').style.display = 'none';
    }
}

function updatePrice(index, value) {
    products[index].price_at_sale = parseFloat(value) || 0;
    updateProductTable();
}

function removeProduct(index) {
    products.splice(index, 1);
    updateProductTable();
}

document.addEventListener('DOMContentLoaded', function () {
    updateProductTable();
    var scanAddRow = document.getElementById('scan-add-row');
    if (products.length > 0 && scanAddRow) scanAddRow.style.display = 'none';

    const saleForm = document.getElementById('saleForm');
    if (!saleForm) return;

    saleForm.addEventListener('submit', function (e) {
        e.preventDefault(); // Stop native submit!

        const customerId = document.getElementById('customerSelect').value;

        if (!customerId) {
            alert('Please select a customer.');
            return;
        }
        if (products.length === 0) {
            alert('Please add at least one product.');
            return;
        }

        const saleFormData = new FormData();
        saleFormData.append('customer_id', customerId);
        products.forEach((product) => {
            saleFormData.append('serials', product.serial_number);
            saleFormData.append(`price_${product.serial_number}`, product.price_at_sale || 0);
        });

        fetch('/confirm_sale', {
            method: 'POST',
            body: saleFormData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.invoice_url) {
                var modal = new bootstrap.Modal(document.getElementById('invoiceOptionsModal'));
                modal.show();
                document.getElementById('modalDownloadInvoiceBtn').onclick = function() {
                    window.open(data.invoice_url, "_blank");
                    modal.hide();
                };
                document.getElementById('modalDoneBtn').onclick = function() {
                    modal.hide();
                    window.location.href = "/create_sale_form";
                };
            } else {
                alert(data.error || "Failed to confirm sale.");
            }
        })
        .catch(err => {
            console.error('Submit error:', err);
            alert('Failed to confirm sale.');
        });
    });
});

document.getElementById('previewInvoiceBtn').addEventListener('click', function () {
    const customerId = document.getElementById('customerSelect').value;
    if (!customerId) {
        alert('Please select a customer.');
        return;
    }
    if (products.length === 0) {
        alert('Please add at least one product.');
        return;
    }
    fetch('/preview_invoice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customer_id: customerId, items: products })
    })
    .then(response => response.text())
    .then(html => {
        // Only update the preview-container (modal body), not the modal header
        document.getElementById('preview-container').innerHTML = html;
        var modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
        modal.show();
    })
    .catch(err => {
        console.error('Preview error:', err);
        alert('Failed to generate invoice preview.');
    });
});

function printPreviewInvoice() {
    // Only print the modal body content
    var printContents = document.getElementById('preview-container').innerHTML;
    var originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    location.reload(); // To reload the original page after print
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="modal fade" id="invoiceOptionsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Sale Completed</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>The sale was successfully completed. Would you like to download the invoice PDF?</p>
      </div>
      <div class="modal-footer">
        <button type="button" id="modalDownloadInvoiceBtn" class="btn btn-primary">Download Invoice PDF</button>
        <button type="button" id="modalDoneBtn" class="btn btn-secondary" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
